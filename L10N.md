# Localization (L10N) Documentation

## Overview

This document describes the translation process, tools, and current status of all language translations for Fulguris Web Browser.

## Translation Tool: `l10n.py`

The `l10n.py` script is a comprehensive Python-based localization tool that manages all translation operations for the project.

### Key Features

- **Batch Translation**: Update multiple strings at once
- **Quality Checking**: Detect untranslated, near-match, and malformed strings
- **Plural Support**: Handle complex plural forms for different languages
- **XML Handling**: Support for complex XML with `<xliff:g>` tags
- **Near-Match Detection**: Find strings differing by 1-2 characters (punctuation, typos)
- **Automated Operations**: Add/remove strings across all language files

### Translation Process

#### 1. Check Translation Status

```bash
# Check all languages (shows first 20 issues per language)
python l10n.py --check

# Check specific language (shows ALL issues)
python l10n.py --check ko-rKR

# Check with near-match detection (finds similar untranslated strings)
python l10n.py --check ko-rKR --near 1
```

#### 2. Translate Strings

**Single String:**
```bash
python l10n.py --set ko-rKR settings_title '설정'
```

**Multiple Strings (Batch):**
```bash
python l10n.py --set ko-rKR \
  enable '사용' \
  disable '사용 안 함' \
  settings '설정'
```

**Complex XML Strings:**
```bash
python l10n.py --set-raw ko-rKR \
  match_x_of_n '<xliff:g id="current_match">%1$d</xliff:g>개 중'
```

#### 3. Handle Plurals

```bash
# Get current plural values
python l10n.py --get-plurals ko-rKR notification_incognito_running_title

# Set plural values
python l10n.py --set-plurals ko-rKR settings_summary_cookies \
  zero '현재 페이지에 쿠키가 없습니다' \
  one '현재 페이지에 쿠키가 1개 있습니다' \
  other '현재 페이지에 쿠키가 %d개 있습니다'
```

#### 4. Get String Values

```bash
python l10n.py --get ko-rKR settings_title
```

### Exclusion Rules

The check tool automatically excludes certain strings from being flagged as untranslated:

**International Terms** (no translation needed):
- `WebView`, `Android`, `iOS`, `Linux`, `macOS`, `Windows`, `Desktop`, `Mobile`
- `JavaScript`, `Cookies`, `Port:`, `LeakCanary`

**String Prefixes** (technical identifiers):
- `agent_*` - User agent strings (e.g., `agent_android_mobile`)
- `log_level_*` - Log level names (e.g., `log_level_warn`)

**Special Strings**:
- `@string/...` - String references
- `android_open_source_project`, `jsoup`, `infinity`, `search_action` - Proper nouns

**Short Strings**:
- Strings with ≤3 characters are excluded from checks

### PowerShell Quoting Tips

When using PowerShell, be careful with special characters:

```powershell
# Use SINGLE quotes for strings with $ placeholders
python l10n.py --set ko-rKR dialog_title '%1$s 열기'

# Or escape $ with backtick in double quotes
python l10n.py --set ko-rKR dialog_title "%1`$s 열기"

# For strings with quotes, use single quotes and escape inner quotes
python l10n.py --set-raw ko-rKR test '<xliff:g id=\"x\">%1$d</xliff:g>개'
```

## Android String Resource Validation

The `l10n.py` script performs comprehensive validation of all string content **before** writing to XML files. This catches errors that would break Android resource compilation.

### Validation Rules

The script validates **ALL** strings (with or without `--raw` flag):

#### Invalid Entity References
- ❌ `&pos;` - Common typo, breaks compilation → Use `\'`
- ❌ `&apos;` - WRONG for Android XML, breaks compilation → Use `\'`  
- ❌ `&quot;` - Wrong for Android → Use `\"`
- ✅ `&amp;` `&lt;` `&gt;` - Valid XML entities
- ✅ `&#123;` `&#x1F4A1;` - Numeric entities are valid

#### XML Structure
- ❌ Unquoted attributes: `id=value` → Must be `id="value"`
- ❌ Unclosed tags: `<xliff:g>text` → Must have `</xliff:g>`
- ❌ Mismatched tags: `<xliff:g></b>` → Tags must match
- ❌ PowerShell backtick escapes: `` `" `` → Use here-strings or `\"`

#### Escape Requirements
- ✅ Apostrophes: Use `\'` (backslash-escape)
- ✅ Quotes: Use `\"` (backslash-escape)  
- ❌ Do NOT use XML entities like `&apos;` or `&quot;`

### Example Validation Errors

```bash
# Invalid entity - will be rejected
python l10n.py --set el-rGR test "Don&apos;t"
# ERROR: Entity '&apos;' detected! Use \' instead.

# Invalid typo - will be rejected  
python l10n.py --set el-rGR test "Test &pos; here"
# ERROR: Invalid entity '&pos;' detected! Use \' for apostrophes.

# Unquoted attribute - will be rejected
python l10n.py --raw --set el-rGR test '<xliff:g id=bad>%s</xliff:g>'
# ERROR: Attribute value not quoted: id=bad
```

### What Gets Validated

- **Regular `--set`**: Validates THEN escapes automatically
- **With `--raw` flag**: Validates WITHOUT escaping (you provide pre-escaped content)

Both modes validate to prevent broken XML from reaching Android compilation.

### ⚠️ CRITICAL: PowerShell XML Quote Escaping

**PowerShell STRIPS quotes from XML attributes even with single quotes!**

The problem: `id="value"` becomes `id=value` which breaks XML parsing.

**The l10n.py script validates ALL XML content** (with or without `--raw`) and will reject malformed XML before it breaks Android compilation. The `--raw` flag only controls whether the script escapes special characters - validation always happens.

✅ **CORRECT - Use PowerShell here-string (BEST for complex XML):**
```powershell
$value = @'
Text <xliff:g id="session_name" example="News">%s</xliff:g>
'@
python l10n.py --raw --set el-rGR message_session_imported $value
```

✅ **ALTERNATIVE - Edit XML file directly for complex strings:**
For strings with quotes inside XML tags, it's often easier and safer to edit the file directly using replace_string_in_file or manual editing.

❌ **WRONG - These all break:**
```powershell
# Double quotes - PowerShell processes \" incorrectly  
python l10n.py --raw --set el-rGR test "text <xliff:g id=\"x\">%s</xliff:g>"

# Single quotes - PowerShell strips the attribute quotes!
python l10n.py --raw --set el-rGR test 'text <xliff:g id="x">%s</xliff:g>'
# Result: <xliff:g id=x> (missing quotes = XML error - WILL BE REJECTED)

# Backtick escaping - Gets passed through incorrectly
python l10n.py --raw --set el-rGR test 'text <xliff:g id=`"x`">%s</xliff:g>'
# Result: <xliff:g id=`x`> (backticks passed through = XML error - WILL BE REJECTED)
```

**Common XML validation errors detected:**
- ❌ PowerShell backtick escapes (`")  → Use backslash (\") or here-strings
- ❌ Missing quotes around attributes (id=value) → Must use quotes (id="value")
- ❌ Unclosed or mismatched XML tags
- ❌ Malformed XML structure

**Why this happens:**
- PowerShell's quote parsing removes quotes from what it sees as bareword arguments
- Even inside single quotes, PowerShell processes the quotes around attribute values
- This is a PowerShell argument parsing quirk, not an issue with the script
- The script detects these issues and rejects them with a clear error message

**Best practice for complex XML:**
1. **Use PowerShell here-strings** (the `@'...'@` syntax) - most reliable
2. **OR edit the XML file directly** for maximum safety and control
3. The `--raw` flag prevents automatic escaping but XML is always validated

### ⚠️ CRITICAL: Apostrophe Escaping in Android XML

**Android XML string resources have specific escaping requirements that differ from standard XML:**

- ✅ **CORRECT:** Use `\'` to escape apostrophes
  ```xml
  <string name="example">Don\'t use &apos; here</string>
  ```

- ❌ **WRONG:** Using `&apos;` will cause **build failures**
  ```xml
  <!-- This will FAIL to compile! -->
  <string name="example">Don&apos;t use this</string>
  ```

**The l10n.py tool automatically detects and fixes `&apos;` issues:**
- When you use `--set` with a value containing `&apos;`, it will:
  1. Display a warning
  2. Automatically convert `&apos;` to `\'`
  3. Show you the before/after values

**Example:**
```bash
python l10n.py --set vi-rVN do_not_track "Yêu cầu &apos;Không theo dõi&apos;"
```
Output:
```
[WARNING] Detected &apos; entity - this is INCORRECT for Android XML!
          Converting &apos; to \' (proper Android XML escape)
          Original value: Yêu cầu &apos;Không theo dõi&apos;
          Fixed value: Yêu cầu 'Không theo dõi'
[OK] Successfully updated vi-rVN:do_not_track
```

## Current Translation Status

**Last Updated:** November 10, 2025

### Completed Languages (99-100%)

| Language | Code | Issues | Status | Notes |
|----------|------|--------|--------|-------|
| **Arabic** | ar-rSA | 1 | ✅ Complete | Format placeholder only |
| **Korean** | ko-rKR | 1 | ✅ Complete | Format placeholder only |
| **Russian** | ru-rRU | 1 | ✅ Complete | Format placeholder only |
| **Ukrainian** | uk-rUA | 1 | ✅ Complete | Format placeholder only |
| **Chinese (CN)** | zh-rCN | 1 | ✅ Complete | Format placeholder only |
| **Vietnamese** | vi-rVN | 1 | ✅ Complete | Format placeholder only |
| **Japanese** | ja-rJP | 2 | ✅ Complete | Format placeholders only |
| **Turkish** | tr-rTR | 2 | ✅ Complete | Format placeholders only |
| **Hungarian** | hu-rHU | 9 | ✅ Complete | Near-match punctuation issues |
| **Polish** | pl-rPL | 9 | ✅ Complete | Near-match punctuation issues |
| **Bosnian** | bs-rBA | 14 | ✅ Complete | Near-match punctuation issues |
| **Dutch** | nl-rNL | 18 | ✅ Complete | Near-match punctuation issues |
| **Spanish** | es-rES | 21 | ✅ Complete | Near-match punctuation issues |
| **Portuguese (PT)** | pt-rPT | 23 | ✅ Complete | Near-match punctuation issues |
| **Portuguese (BR)** | pt-rBR | 26 | ✅ Complete | Near-match punctuation issues |
| **French** | fr-rFR | 35 | ✅ Complete | Near-match punctuation issues |
| **German** | de-rDE | 37 | ✅ Complete | Near-match punctuation issues |
| **Italian** | it-rIT | 38 | ✅ Complete | Near-match punctuation issues |
| **Indonesian** | in-rID | 31 | ✅ Complete | Technical terms kept in English |
| **Serbian (Latin)** | sr-rSP | 62 | ✅ Complete | Minor issues remaining |
| **Chinese (TW)** | zh-rTW | ~10 | ✅ Complete | Fully translated |
| **Swedish** | sv-rSE | ~10 | ✅ Complete | Fully translated |
| **Greek** | el-rGR | ~10 | ✅ Complete | Fully translated |

### High Quality (90-99%)

| Language | Code | Issues | Completion | Notes |
|----------|------|--------|------------|-------|
| **Serbian (Cyrillic)** | sr-rCS | 75 | ~87% | Layer types, SSL errors, panel strings |
| **Croatian** | hr-rHR | 74 | ~87% | Layer types, SSL errors, panel strings |

### Needs Work (40-69%)

| Language | Code | Issues | Completion | Notes |
|----------|------|--------|------------|-------|
| **Czech** | cs-rCZ | 417 | ~28% | Major work needed |
| **Montenegro** | me-rME | 484 | ~17% | Extensive translation needed |

### Minimal Translation (0-39%)

| Language | Code | Issues | Completion | Notes |
|----------|------|--------|------------|-------|
| **Santali** | sat-rIN | 527 | ~10% | Almost complete retranslation needed |
| **Lithuanian** | lt-rLT | 533 | ~9% | Almost complete retranslation needed |
| **Thai** | th-rTH | 546 | ~7% | Almost complete retranslation needed |
| **Hebrew** | iw-rIL | 550 | ~6% | Almost complete retranslation needed |
| **Afrikaans** | af-rZA | 554 | ~5% | Almost complete retranslation needed |
| **Catalan** | ca-rES | 555 | ~5% | Almost complete retranslation needed |
| **Danish** | da-rDK | 555 | ~5% | Almost complete retranslation needed |
| **Finnish** | fi-rFI | ~50 | ~92% | Nearly complete - 500+ strings translated in comprehensive effort |
| **Norwegian** | no-rNO | 555 | ~5% | Almost complete retranslation needed |
| **Romanian** | ro-rRO | 555 | ~5% | Almost complete retranslation needed |

**Total Languages:** 37  
**Languages with ≤10 issues:** 7 (19%)  
**Languages with 11-70 issues:** 13 (35%)  
**Languages with 71-200 issues:** 3 (8%)  
**Languages with >500 issues:** 14 (38%)  
**Languages 99%+ Complete:** 19 (51%)

## Common Untranslated Strings

These strings are frequently untranslated across multiple languages:

### Format Placeholders
- `dialog_message_incoming_url` = `'%1$s\n\n%2$s'` - Intentionally left as-is

### User Agent Strings (Intentionally Untranslated)
- `agent_android_mobile` = `'Android (Mobile)'`
- `agent_ios_mobile` = `'iOS (Mobile)'`
- `agent_linux_desktop` = `'Linux (Desktop)'`
- `agent_macos_desktop` = `'macOS (Desktop)'`
- `agent_windows_desktop` = `'Windows (Desktop)'`

### Frequently Missing Translations
1. **Introduction/Settings:**
   - `settings_title_introduction` = `'Introduction'`
   - `settings_title_delete_configuration` = `'Delete configuration'`
   - `settings_title_add_configuration` = `'Add configuration'`

2. **Accent Colors:**
   - `accent_color`, `accent_amber`, `accent_blue`, `accent_cyan`, etc.

3. **Layer Types:**
   - `layer_type_none` = `'None'`
   - `layer_type_software` = `'Software - WebGL off'`
   - `layer_type_hardware` = `'Hardware - WebGL on'`

4. **SSL Information:**
   - `ssl_info_issued_by` = `'Issued by:'`
   - `ssl_info_issued_to` = `'Issued to:'`
   - `ssl_info_issued_on` = `'Issued on:'`
   - `ssl_info_expires_on` = `'Expires on:'`

5. **Session Management:**
   - `label_session` = `'Session'`
   - `session_recovery` = `'Recovery'`
   - `session_name_prompt` = `'Enter session name:'`

## Translation Quality Metrics

### Total Strings
- **Regular Strings:** 583
- **Plural Resources:** 2
  - `notification_incognito_running_title` (incognito tab count)
  - `settings_summary_cookies` (cookie count)

### Completion Criteria

A language is considered "complete" when:
1. All translatable strings are translated (excluding proper nouns)
2. All plural forms are properly handled
3. No placeholder mismatches exist
4. Near-match issues are resolved (punctuation, typos)

### Quality Checks Performed

1. **Untranslated Detection:** Exact match with English text
2. **Near-Match Detection:** 1-2 character differences (punctuation, typos)
3. **Placeholder Consistency:** Verify `%s`, `%1$d`, `<xliff:g>` tags match
4. **Plural Completeness:** Check all required quantities are translated
5. **XML Validation:** Ensure proper XML structure and escaping

## Maintenance Tasks

### Adding New Strings

```bash
# Add a new string to all language files
python l10n.py --add new_feature_name "New Feature"
```

### Removing Obsolete Strings

```bash
# Remove a string from all language files
python l10n.py --remove obsolete_string_id
```

### Listing All Languages

```bash
python l10n.py --list
```

## Best Practices

### For Translators

1. **Use Native Speakers:** Always prefer native speakers for translation quality
2. **Context Matters:** Understand the UI context where strings appear
3. **Consistency:** Use consistent terminology throughout translations
4. **Plural Forms:** Ensure proper plural forms for your language
5. **Format Preservation:** Maintain `%s`, `%1$d`, `<xliff:g>` placeholders exactly
6. **Cultural Appropriateness:** Adapt idioms and phrases culturally

### For Developers

1. **Check Before Commit:** Run `python l10n.py --check` before committing
2. **Update All Languages:** Use `--add` to add new strings to all languages
3. **Document Context:** Add comments in English strings.xml for context
4. **Test RTL Languages:** Test Arabic, Hebrew for right-to-left display
5. **Validate XML:** Ensure proper XML escaping for special characters

## Technical Details

### String Escaping Rules

**⚠️ Android XML Resources vs Standard XML:**

Android uses a **modified XML format** for string resources that has different escaping rules than standard XML:

**Regular Strings** (`--set`):
- Apostrophes (`'`) → `\'` ✅ **REQUIRED** (not `&apos;` ❌)
- Quotes (`"`) → `\"` ✅ **REQUIRED** (not `&quot;` ❌)
- Ampersands (`&`) → `&amp;` (standard XML entity)
- Less than (`<`) → `&lt;` (unless part of XML tag like `<xliff:g>`)
- Greater than (`>`) → `&gt;` (unless part of XML tag)

**Why `&apos;` doesn't work:**
- Standard XML allows `&apos;` as a character entity
- Android's resource compiler does **NOT** accept `&apos;` in string values
- Using `&apos;` will cause: `Failed to compile values resource file` error
- Solution: Always use `\'` for apostrophes in Android string resources

**The l10n.py tool protects you:**
- Automatically detects `&apos;` and `&quot;` in your input
- Displays warnings when these incorrect entities are found
- Converts them to the correct `\'` and `\"` escapes
- Prevents build failures before they happen

**Raw Strings** (`--set-raw`):
- No automatic escaping
- Used for complex XML with `<xliff:g>`, `<b>` tags
- Developer must handle escaping manually
- Still subject to Android's `\'` requirement (not `&apos;`)

### Plural Forms by Language

Different languages have different plural rules:

- **English, German, Dutch:** `one`, `other`
- **French, Portuguese:** `one`, `other`
- **Russian, Ukrainian:** `one`, `few`, `many`, `other`
- **Arabic:** `zero`, `one`, `two`, `few`, `many`, `other`
- **Korean, Japanese, Chinese:** `other` only (no plural distinction)
- **Polish:** `one`, `few`, `many`, `other`

## Known Issues

1. **Format Placeholder String:** `dialog_message_incoming_url` shows as "untranslated" in all languages - this is intentional as it's just `'%1$s\n\n%2$s'`

2. **Near-Match Default:** The tool defaults to `--near 1` to catch punctuation differences

3. **XML Encoding Issues:** Some language files may have encoding issues visible in logs (displayed as `��` characters) but files are correctly UTF-8 encoded

## Future Improvements

1. **Crowdin Integration:** Document integration with Crowdin for community translations
2. **Translation Memory:** Build translation memory for consistency
3. **Automated Testing:** Add unit tests for translation completeness
4. **Context Screenshots:** Provide screenshots showing where strings appear in UI
5. **Glossary:** Create terminology glossary for consistent translations

## Support

For translation questions or issues:
1. Check this documentation first
2. Run `python l10n.py --help` for command reference
3. Test translations with `python l10n.py --check <lang>`
4. Open an issue on GitHub with the `l10n` label

---

## Regression Testing

### Overview

The `l10n.py` script includes comprehensive Android string resource validation. These tests should be run after any changes to the script or to validate it's working correctly.

### Quick Validation Test Suite

Run these commands to verify all functionality:

```powershell
# 1. Test help displays correctly
python l10n.py --help

# 2. Test language list
python l10n.py --list

# 3. Test check command (should complete without errors)
python l10n.py --check el-rGR

# 4. Test get command
python l10n.py --get el-rGR show

# 5. Test get-plurals command
python l10n.py --get-plurals el-rGR notification_incognito_running_title
```

### Validation Tests (Should Fail with Clear Errors)

These tests verify that validation is working correctly by testing invalid inputs:

```powershell
# Test 1: Invalid entity &pos; (should FAIL)
python l10n.py --set el-rGR show "Test &pos; here"
# Expected: ERROR - Invalid entity '&pos;' detected!

# Test 2: Invalid entity &apos; (should FAIL)
python l10n.py --raw --set el-rGR show "Don&apos;t use this"
# Expected: ERROR - Entity '&apos;' detected! Use \' instead.

# Test 3: Invalid entity &quot; (should FAIL)  
python l10n.py --raw --set el-rGR show 'Text &quot;quoted&quot;'
# Expected: ERROR - Entity '&quot;' detected! Use \" instead.

# Test 4: Unquoted XML attribute (should FAIL)
python l10n.py --raw --set el-rGR show '<xliff:g id=bad>%s</xliff:g>'
# Expected: ERROR - Attribute value not quoted: id=bad

# Test 5: PowerShell backtick escape (should FAIL)
python l10n.py --raw --set el-rGR show 'Test `"quoted`"'
# Expected: ERROR - PowerShell backtick escapes detected

# Test 6: Mismatched XML tags (should FAIL)
python l10n.py --raw --set el-rGR show '<xliff:g>text</b>'
# Expected: ERROR - Mismatched tags

# Test 7: Unclosed XML tag (should FAIL)
python l10n.py --raw --set el-rGR show '<xliff:g id="test">text'
# Expected: ERROR - Unclosed tag(s)

# Test 8: Invalid custom entity (should FAIL)
python l10n.py --raw --set el-rGR show 'Text &custom; entity'
# Expected: ERROR - Invalid entity reference(s): &custom;

# Test 9: Unterminated entity (should FAIL)
python l10n.py --raw --set el-rGR show 'Text &amp more'
# Expected: ERROR - Unterminated entity reference: '&amp'
```

### Valid Input Tests (Should Succeed)

These tests verify that valid inputs are accepted:

```powershell
# Test 1: Simple text (should SUCCEED)
python l10n.py --set el-rGR show "Εμφάνιση"
# Expected: [OK] Successfully updated

# Test 2: Text with placeholder (should SUCCEED)
python l10n.py --set el-rGR dialog_title '%1$s settings'
# Expected: [OK] Successfully updated

# Test 3: Valid XML with --raw and here-string (should SUCCEED)
$value = @'
Match <xliff:g id="current_match" example="1">%1$d</xliff:g> of <xliff:g id="match_count" example="10">%2$d</xliff:g>
'@
python l10n.py --raw --set el-rGR match_x_of_n $value
# Expected: [OK] Successfully updated

# Test 4: Valid entities (should SUCCEED)
python l10n.py --raw --set el-rGR test 'Text &amp; &lt; &gt; symbols'
# Expected: [OK] Successfully updated

# Test 5: Numeric entities (should SUCCEED)
python l10n.py --raw --set el-rGR test 'Text &#169; &#x1F4A1; entities'
# Expected: [OK] Successfully updated

# Test 6: Batch update (should SUCCEED)
python l10n.py --set el-rGR enable 'Enable' disable 'Disable' show 'Show'
# Expected: [OK] for all three strings

# Test 7: Plural update (should SUCCEED)
python l10n.py --set-plurals el-rGR notification_incognito_running_title other '%1$d tabs'
# Expected: [OK] Updated quantity 'other'
```

### XML Compilation Test

After any changes, verify that Android XML resources compile correctly:

```powershell
# Verify all translation files have valid XML structure
python -c "import xml.etree.ElementTree as ET; import pathlib; res_dir = pathlib.Path('app/src/main/res'); files = list(res_dir.glob('values-*/strings.xml')); print(f'Checking {len(files)} files...'); [ET.parse(f) for f in files]; print('All XML files valid!')"
```

### Automated Test Script

For convenience, use the provided test script:

```powershell
# Run all regression tests
python test_l10n.py
```

### Test Coverage

The regression tests cover:

- ✅ **Command Interface**: All commands execute without errors
- ✅ **Validation Logic**: Invalid inputs are rejected with clear errors  
- ✅ **Valid Inputs**: Legitimate strings are accepted
- ✅ **Android Entities**: `&apos;`, `&quot;`, `&pos;` detection
- ✅ **XML Structure**: Tag matching, attribute quoting
- ✅ **PowerShell Issues**: Backtick escape detection
- ✅ **Entity References**: Valid vs invalid entities
- ✅ **Batch Operations**: Multiple strings at once
- ✅ **Plural Support**: Plural quantity handling
- ✅ **XML Compilation**: Final XML is valid and parseable

### When to Run Tests

Run regression tests:

1. **After modifying `l10n.py`** - Ensure changes didn't break existing functionality
2. **Before committing** - Verify all validation logic works
3. **When reporting issues** - Confirm the issue with test cases
4. **Periodically** - Ensure tool remains functional as project evolves

### Adding New Tests

When adding new validation rules to `l10n.py`, add corresponding tests to this section showing:
1. What the rule validates
2. Example of invalid input that should be rejected
3. Example of valid input that should be accepted
4. Expected error message for failures

---

**Maintained by:** Fulguris Development Team  
**Tool Version:** 1.0  
**Last Major Update:** November 2025

